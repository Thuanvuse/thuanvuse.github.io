from qtpy.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QTableWidget, QTableWidgetItem,
    QGraphicsDropShadowEffect, QHeaderView, QCheckBox, QLabel, QPushButton, QAbstractItemView,
    QFrame, QMenu, QMessageBox, QDialog, QTabWidget, QFormLayout, QLineEdit, QSpinBox,
    QGridLayout
)
from qtpy.QtGui import QColor, QFont, QCursor, QAction, QIcon, QPixmap
from qtpy.QtCore import Qt, QPropertyAnimation, QRect, QTimer, QPoint, QRunnable, QThreadPool, Signal, QObject, QDate, QThread, QVariantAnimation
import sys
import os
import requests
import hashlib
import threading
import time
import uuid

FILE_PATH = "ACC.txt"

class AnimatedToggle(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setFixedSize(60, 30)
        self.checkbox = QCheckBox(self)
        self.checkbox.setGeometry(0, 0, 60, 30)
        self.checkbox.setCursor(Qt.PointingHandCursor)
        self.checkbox.setStyleSheet("""
            QCheckBox::indicator {
                width: 60px;
                height: 30px;
                border-radius: 15px;
                background-color: #ddd;
            }
            QCheckBox::indicator:checked {
                background-color: #6666ff;
            }
        """)
        self.icon = QLabel("\ud83c\udf1e", self)
        self.icon.setGeometry(3, 3, 24, 24)
        self.icon.setFont(QFont("Arial", 16))
        self.icon.setAlignment(Qt.AlignCenter)
        self.icon.setStyleSheet("background: transparent;")
        self.anim = QPropertyAnimation(self.icon, b"geometry")
        self.checkbox.stateChanged.connect(self.start_animation)

    def start_animation(self, state):
        if state:
            self.anim.setStartValue(QRect(3, 3, 24, 24))
            self.anim.setEndValue(QRect(33, 3, 24, 24))
            self.icon.setText("\ud83c\udf19")
        else:
            self.anim.setStartValue(QRect(33, 3, 24, 24))
            self.anim.setEndValue(QRect(3, 3, 24, 24))
            self.icon.setText("\ud83c\udf1e")
        self.anim.setDuration(200)
        self.anim.start()

    def isChecked(self):
        return self.checkbox.isChecked()

    def stateChanged(self, func):
        self.checkbox.stateChanged.connect(func)

class LoginSignals(QObject):
    update_status = Signal(int, str)  # row, status
    login_result = Signal(int, str, str, object, object)  # row, token, result, diem, error_msg

class LoginWorker(QRunnable):
    def __init__(self, row, account, password, f_id, proxy_string, token=None):
        super().__init__()
        self.row = row
        self.account = account
        self.password = password
        self.f_id = f_id
        self.proxy_string = proxy_string
        self.token = token
        self.signals = LoginSignals()

    def create_proxy(self, proxy_string):
        parts = proxy_string.split(":")
        ip = parts[0]
        port = parts[1]
        username = parts[2]
        password = parts[3]
        proxies = {
            "http": f"http://{username}:{password}@{ip}:{port}",
            "https": f"http://{username}:{password}@{ip}:{port}"
        }
        return proxies

    def check_token_live(self, token, f_id, proxy_string):
        import requests
        proxies = self.create_proxy(proxy_string)
        try:
            headers = {
                "authority": "m.oklavip26.live",
                "accept": "application/json, text/plain, */*",
                "accept-language": "vi-VN,vi;q=0.9",
                "content-type": "application/json",
                "locale": "vi_vn",
                "referer": "https://m.oklavip26.live/personal",
                "sec-ch-ua-platform": "Windows",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-origin",
                "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                "f-id": f_id,
                "token": token,
            }
            responsediem = requests.get("https://m.oklavip26.live/api/wallet/getWallet", headers=headers, proxies=proxies, timeout=20).json()
            print(responsediem)
            diem = responsediem['data']['integral']
            return False, diem  # False = token c√≤n s·ªëng
        except Exception as e:
            print(f"CheckTokenLive Exception: {e}")
            return True, None  # True = token die

    def run(self):
        import requests, hashlib
        from qtpy.QtWidgets import QTableWidgetItem
        # Ki·ªÉm tra token tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p
        if self.token and self.token.strip():
            self.signals.update_status.emit(self.row, "ƒêang ki·ªÉm tra token...")
            is_die, diem = self.check_token_live(self.token, self.f_id, self.proxy_string)
            if not is_die:
                self.signals.update_status.emit(self.row, f"Token s·ªëng | ƒêi·ªÉm: {diem}")
                # C·∫≠p nh·∫≠t ƒëi·ªÉm v√†o c·ªôt 5
                self.signals.login_result.emit(self.row, self.token, "TOKEN_OK", diem, None)
                return
            else:
                self.signals.update_status.emit(self.row, "Token die, ƒëƒÉng nh·∫≠p l·∫°i...")
        # N·∫øu token die ho·∫∑c kh√¥ng c√≥, ti·∫øn h√†nh ƒëƒÉng nh·∫≠p nh∆∞ c≈©
        def create_proxy(proxy_string):
            parts = proxy_string.split(":")
            ip = parts[0]
            port = parts[1]
            username = parts[2]
            password = parts[3]
            proxies = {
                "http": f"http://{username}:{password}@{ip}:{port}",
                "https": f"http://{username}:{password}@{ip}:{port}"
            }
            return proxies
        proxies = create_proxy(self.proxy_string)
        url = "https://oklavip26.live/api/accountLogin/captcha"
        headers_captcha = {
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "vi-VN,vi;q=0.9",
            "referer": "https://oklavip26.live/?backRoute=%2Fpersonal",
            "sec-ch-ua": '"Chromium";v="136", "Google Chrome";v="136", "Not.A/Brand";v="99"',
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": '"Windows"',
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
        }
        attempts = 0
        last_error_msg = None
        while attempts < 3:
            try:
                self.signals.update_status.emit(self.row, f"L·∫•y captcha (l·∫ßn {attempts+1})...")
                response = requests.get(url, headers=headers_captcha, proxies=proxies)
                print(response.status_code)
                print(response.json())
                img = response.json()
                img_src, uuid = img['data']['image'], img['data']['uuid']
                self.signals.update_status.emit(self.row, "ƒêang nh·∫≠n di·ªán captcha...")
                ocr_response = requests.post("http://103.77.242.210:8000/ocr", headers={"accept": "application/json"}, data={"image": img_src}, verify=False).json()
                code = ocr_response['data']
                password_md5 = hashlib.md5(self.password.encode('utf-8')).hexdigest()
                headers_login = {
                    "authority": "m.oklavip26.live",
                    "accept": "application/json, text/plain, */*",
                    "accept-language": "vi-VN,vi;q=0.9",
                    "content-type": "application/json",
                    "locale": "vi_vn",
                    "origin": "https://m.oklavip26.live",
                    "priority": "u=1, i",
                    "referer": "https://m.oklavip26.live/login",
                    "sec-ch-ua": '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": "Windows",
                    "sec-fetch-dest": "empty",
                    "sec-fetch-mode": "cors",
                    "sec-fetch-site": "same-origin",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                    "f-id": self.f_id
                }
                data = {
                    "account": self.account,
                    "password": password_md5,
                    "code": code,
                    "uuid": uuid,
                    "device": "H5"
                }
                self.signals.update_status.emit(self.row, "ƒêang g·ª≠i th√¥ng tin ƒëƒÉng nh·∫≠p...")
                response = requests.post(
                    "https://m.oklavip26.live/api/accountLogin/doLogin",
                    headers=headers_login,
                    json=data,
                    proxies=proxies,
                    timeout=20,
                )
                print(response.json())
                resp_json = response.json()
                if resp_json['code'] == 200:
                    print("Login successful!")
                    print(f"Token: {resp_json['data']['token']}")
                    self.signals.update_status.emit(self.row, "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!")
                    self.signals.login_result.emit(self.row, resp_json['data']['token'], "DONE", None, None)
                    return
                elif resp_json['code'] == 40000:
                    print("Invalid captcha code, try again.")
                    self.signals.update_status.emit(self.row, f"Sai captcha, th·ª≠ l·∫°i ({attempts+1})...")
                    attempts += 1
                else:
                    error_msg = resp_json.get('message', 'Kh√¥ng r√µ')
                    print(f"Error: {error_msg}")
                    last_error_msg = error_msg
                    self.signals.update_status.emit(self.row, f"L·ªói: {error_msg}")
                    break
            except Exception as e:
                print(f"Exception: {e}")
                attempts += 1
                self.signals.update_status.emit(self.row, f"L·ªói: {str(e)} (th·ª≠ l·∫°i {attempts})")
                last_error_msg = str(e)
        print("Failed to login after 3 attempts.")
        self.signals.update_status.emit(self.row, "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!")
        try:
            self.signals.login_result.emit(self.row, "", "FAILED", None, last_error_msg)
        except Exception as e:
            print(f"Emit failed: {e}")

class Table3D(QWidget):
    file_lock = threading.Lock()
    def __init__(self):
        self.device_id = get_device_id()
        # Ki·ªÉm tra m√£ m√°y tr∆∞·ªõc khi cho d√πng tool
        if not is_device_allowed(self.device_id):
            self.show_device_id_dialog()
            QWidget.__init__(self)
            self.setDisabled(True)
            # Kh√¥ng g·ªçi init_ui n·∫øu ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t
            return
        QWidget.__init__(self)
        self.setWindowTitle("OKVIP TOOL")
        self.resize(1200, 700)
        self.is_dark = False
        self.password_map = {}
        self.password_shown = set()
        self.threadpool = QThreadPool()
        self.threadpool.setMaxThreadCount(200)
        self.is_login_all = False
        self.sidebar_visible = True
        self.init_ui()
        # Ki·ªÉm tra l·∫°i m·ªói 10 ph√∫t
        self.device_check_timer = QTimer(self)
        self.device_check_timer.timeout.connect(self.check_device_periodically)
        self.device_check_timer.start(10 * 60 * 1000)

    def check_device_periodically(self):
        try:
            if not is_device_allowed(self.device_id):
                self.setDisabled(True)
                self.show_device_id_dialog()
        except Exception as e:
            print("L·ªói ki·ªÉm tra l·∫°i m√£ m√°y:", e)

    def show_device_id_dialog(self):
        from qtpy.QtWidgets import QDialog, QVBoxLayout, QLabel, QPushButton, QHBoxLayout, QApplication, QMessageBox
        import sys
        dialog = QDialog()
        dialog.setWindowTitle("K√≠ch ho·∫°t thi·∫øt b·ªã")
        layout = QVBoxLayout(dialog)
        label = QLabel(f"<b>M√£ m√°y c·ªßa b·∫°n l√†:</b>\n\n<code style='font-size:18px'>{self.device_id}</code>\n\n<font color='red'>G·ª≠i m√£ n√†y cho admin ƒë·ªÉ ƒë∆∞·ª£c k√≠ch ho·∫°t!</font>")
        label.setWordWrap(True)
        layout.addWidget(label)
        # Th√™m c√°c n√∫t ch·ª©c nƒÉng
        btn_layout = QHBoxLayout()
        btn_copy = QPushButton("Copy m√£ m√°y")
        btn_copy.setStyleSheet("font-size:10px; color:#fff; background:#ff9800; border-radius:6px; padding:2px 8px;")
        btn_copy.setCursor(Qt.PointingHandCursor)
        def copy_device_id():
            clipboard = QApplication.clipboard()
            clipboard.setText(self.device_id)
            QMessageBox.information(dialog, "Copy m√£ m√°y", "ƒê√£ copy m√£ m√°y v√†o clipboard!")
        btn_copy.clicked.connect(copy_device_id)
        btn_layout.addWidget(btn_copy)
        btn_tele = QPushButton("Li√™n h·ªá Telegram")
        btn_tele.setStyleSheet("font-size:10px; color:#fff; background:#229ed9; border-radius:6px; padding:2px 8px;")
        btn_tele.setCursor(Qt.PointingHandCursor)
        def open_telegram():
            import webbrowser
            webbrowser.open("https://t.me/t29032006")
        btn_tele.clicked.connect(open_telegram)
        btn_layout.addWidget(btn_tele)
        btn_close = QPushButton("ƒê√≥ng")
        def close_and_exit():
            dialog.accept()
            sys.exit(0)
        btn_close.clicked.connect(close_and_exit)
        btn_layout.addWidget(btn_close)
        layout.addLayout(btn_layout)
        dialog.exec_()

    def toggle_theme(self, state):
        self.is_dark = bool(state)
        if self.is_dark:
            self.apply_dark_theme()
        else:
            self.apply_light_theme()

    def apply_light_theme(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                color: #000;
            }
            QTableWidget {
                background-color: #ffffff;
                alternate-background-color: #f9f9f9;
            }
            QLabel {
                color: #333;
            }
        """)
        # self.total_label.setStyleSheet("color: #333;")  # ƒê√£ b·ªè total_label

    def apply_dark_theme(self):
        self.setStyleSheet("""
            QWidget {
                background-color: #2b2b2b;
                color: #fff;
            }
            QTableWidget {
                background-color: #3c3f41;
                alternate-background-color: #313335;
            }
            QLabel {
                color: #fff;
            }
        """)
        # self.total_label.setStyleSheet("color: #fff;")  # ƒê√£ b·ªè total_label

    def toggle_sidebar(self):
        self.sidebar.setVisible(not self.sidebar.isVisible())
        self.sidebar_visible = self.sidebar.isVisible()
        if self.sidebar_visible:
            self.menu_btn.setText("‚ùÆ")
            self.floating_menu_btn.hide()
        else:
            self.floating_menu_btn.show()

    def show_sidebar(self):
        self.sidebar.setVisible(True)
        self.sidebar_visible = True
        self.menu_btn.setText("‚ùÆ")
        self.floating_menu_btn.hide()

    def update_thread_count(self):
        """C·∫≠p nh·∫≠t s·ªë lu·ªìng t·ªëi ƒëa cho threadpool"""
        new_count = self.thread_spinbox.value()
        self.threadpool.setMaxThreadCount(new_count)
        print(f"[LOG] ƒê√£ c·∫≠p nh·∫≠t s·ªë lu·ªìng t·ªëi ƒëa: {new_count}")

    def save_row_to_file(self, row):
        """Helper function to save a row to ACC.txt file safely"""
        try:
            acc_file = FILE_PATH
            with self.file_lock:
                # ƒê·ªçc t·ª´ file g·ªëc tr∆∞·ªõc
                if os.path.exists(acc_file):
                    with open(acc_file, "r", encoding="utf-8") as f:
                        lines = f.readlines()
                else:
                    lines = []
                
                # T·∫°o file t·∫°m v√† ghi d·ªØ li·ªáu
                tmp_file = acc_file + ".tmp"
                if 0 <= row < len(lines):
                    new_cells = []
                    for col in range(self.table.columnCount()):
                        item = self.table.item(row, col)
                        new_cells.append(item.text() if item else "")
                    if len(new_cells) < 8:
                        new_cells += [""] * (8 - len(new_cells))
                    lines[row] = "|".join(new_cells) + "\n"
                
                with open(tmp_file, "w", encoding="utf-8") as f:
                    f.writelines(lines)
                    f.flush()
                    os.fsync(f.fileno())
                os.replace(tmp_file, acc_file)
                return True
        except Exception as e:
            print(f"[LOG] L·ªói l∆∞u d√≤ng v√†o file ACC.txt: {e}")
            return False

    def init_ui(self):
        main_layout = QHBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)

        # --- SIDEBAR ---
        self.sidebar = QFrame()
        self.sidebar.setObjectName("sidebar")
        self.sidebar.setFixedWidth(320)
        self.sidebar.setStyleSheet('''
            QFrame#sidebar {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #fff9f1, stop:1 #ffe0b2);
                border-top-right-radius: 32px;
                border-bottom-right-radius: 32px;
                border: 1.5px solid #ffe0b2;
            }
        ''')
        sidebar_layout = QVBoxLayout(self.sidebar)
        sidebar_layout.setContentsMargins(24, 24, 24, 24)
        sidebar_layout.setSpacing(18)

        # Menu button (collapse/expand)
        self.menu_btn = QPushButton("‚ùÆ")
        self.menu_btn.setFixedSize(32, 32)
        self.menu_btn.setStyleSheet("QPushButton{background:#fff3e0;border-radius:16px;font-size:20px;color:#ff9800;font-weight:bold;border:1.5px solid #ffe0b2;} QPushButton:hover{background:#ffe0b2;}")
        self.menu_btn.clicked.connect(self.toggle_sidebar)
        sidebar_layout.addWidget(self.menu_btn, alignment=Qt.AlignLeft)

        # Toggle theme (s√°ng/t·ªëi) chuy·ªÉn v√†o sidebar
        self.toggle = AnimatedToggle()
        self.toggle.stateChanged(self.toggle_theme)
        sidebar_layout.addWidget(self.toggle, alignment=Qt.AlignLeft)

        # Spin box ƒëi·ªÅu ch·ªânh s·ªë lu·ªìng
        thread_frame = QFrame()
        thread_frame.setStyleSheet("background:#fff; border-radius:8px; border:1px solid #ffe0b2; padding:4px;")
        thread_layout = QVBoxLayout(thread_frame)
        thread_layout.setContentsMargins(4, 4, 4, 4)
        thread_layout.setSpacing(2)
        
        thread_label = QLabel(" S·ªë Lu·ªìng T·ªëi ƒêA")
        thread_label.setStyleSheet("font-size:8px;color:#ff9800;font-weight:bold;text-align:center;")
        thread_label.setAlignment(Qt.AlignCenter)
        thread_layout.addWidget(thread_label)
        
        self.thread_spinbox = QSpinBox()
        self.thread_spinbox.setMinimum(10)
        self.thread_spinbox.setMaximum(5000)
        self.thread_spinbox.setValue(200)  # M·∫∑c ƒë·ªãnh 100 lu·ªìng
        self.thread_spinbox.setStyleSheet("""
            QSpinBox {
                background:#fff3e0;
                border:1px solid #ffe0b2;
                border-radius:10px;
                padding:2px;
                font-size:20px;
                font-weight:bold;
                color:#ff9800;
                text-align:center;
                min-width: 40px;
            }
            QSpinBox::up-button, QSpinBox::down-button {
                background:#ffe0b2;
                border-radius:2px;
                margin:1px;
                width: 20px;
                height: 20px;
            }
            QSpinBox::up-button:hover, QSpinBox::down-button:hover {
                background:#ffb74d;
            }
        """)
        self.thread_spinbox.valueChanged.connect(self.update_thread_count)
        thread_layout.addWidget(self.thread_spinbox)
        
        sidebar_layout.addWidget(thread_frame)

        # Avatar + t√™n + ID
        avatar_label = QLabel()
        avatar_pixmap = QPixmap()
        avatar_pixmap.loadFromData(requests.get("https://d2kiqw8o04hzvt.cloudfront.net/okvip-live/1750948711277.png").content)
        avatar_label.setPixmap(avatar_pixmap.scaled(40, 40, Qt.KeepAspectRatio, Qt.SmoothTransformation))
        avatar_label.setFixedSize(40, 40)
        avatar_label.setStyleSheet("border-radius: 40px; background: #fff; border: 3px solid #ffe0b2;")
        avatar_label.setAlignment(Qt.AlignCenter)
        sidebar_layout.addWidget(avatar_label, alignment=Qt.AlignHCenter)
        name_label = QLabel("<b>Ch√∫c b·∫°n 1 ng√†y m·ªõi t·ªët l√†nh</b>")
        name_label.setStyleSheet("font-size: 14px; color: #ff9800; font-weight: bold;")
        name_label.setAlignment(Qt.AlignHCenter)
        sidebar_layout.addWidget(name_label)
        id_label = QLabel(f'<span style="color:#ff9800;">üÜî</span> <b>{self.device_id}</b>')
        id_label.setStyleSheet("font-size: 20px; color: #ff9800; background:#ede7e3; border-radius:4px; padding:1px 4px; margin-bottom:4px;")
        id_label.setAlignment(Qt.AlignHCenter)
        sidebar_layout.addWidget(id_label)
        # Th√™m n√∫t copy m√£ m√°y
        copy_layout = QHBoxLayout()
        btn_copy = QPushButton("Copy m√£ m√°y")
        btn_copy.setStyleSheet("font-size:10px; color:#fff; background:#ff9800; border-radius:6px; padding:2px 8px;")
        btn_copy.setCursor(Qt.PointingHandCursor)
        def copy_device_id():
            clipboard = QApplication.clipboard()
            clipboard.setText(self.device_id)
            QMessageBox.information(self, "Copy m√£ m√°y", "ƒê√£ copy m√£ m√°y v√†o clipboard!")
        btn_copy.clicked.connect(copy_device_id)
        copy_layout.addWidget(btn_copy)
        # Th√™m n√∫t li√™n h·ªá Telegram
        btn_tele = QPushButton("Li√™n h·ªá Telegram")
        btn_tele.setStyleSheet("font-size:10px; color:#fff; background:#229ed9; border-radius:6px; padding:2px 8px;")
        btn_tele.setCursor(Qt.PointingHandCursor)
        def open_telegram():
            import webbrowser
            webbrowser.open("https://t.me/t29032006")
        btn_tele.clicked.connect(open_telegram)
        copy_layout.addWidget(btn_tele)
        sidebar_layout.addLayout(copy_layout)

        # Block t·ªïng acc/t·ªïng ƒëi·ªÉm
        stats_frame = QFrame()
        stats_layout = QHBoxLayout(stats_frame)
        stats_layout.setSpacing(12)
        stats_layout.setContentsMargins(0, 0, 0, 0)
        # T·ªïng acc
        acc_box = QFrame()
        acc_box.setStyleSheet("background:#fff; border-radius:12px; border:2px solid #ffe0b2;")
        acc_box.setFixedSize(120, 60)
        acc_v = QVBoxLayout(acc_box)
        acc_v.setContentsMargins(6, 4, 6, 4)
        acc_v.setSpacing(0)
        acc_icon = QLabel("üßæT·ªïng Acc")
        acc_icon.setStyleSheet("font-size:15px;color:#ff9800;font-weight:bold;")
        acc_icon.setAlignment(Qt.AlignCenter)
        acc_v.addWidget(acc_icon)
        self.acc_value = QLabel('0')
        self.acc_value.setStyleSheet("font-size:20px;font-weight:bold;color:#ff9800;")
        self.acc_value.setAlignment(Qt.AlignCenter)
        acc_v.addWidget(self.acc_value)
        stats_layout.addWidget(acc_box)
        # T·ªïng ƒëi·ªÉm
        diem_box = QFrame()
        diem_box.setStyleSheet("background:#fff; border-radius:12px; border:2px solid #ffe0b2;")
        diem_box.setFixedSize(120, 60)
        diem_v = QVBoxLayout(diem_box)
        diem_v.setContentsMargins(6, 4, 6, 4)
        diem_v.setSpacing(0)
        diem_icon = QLabel("üí∞T·ªïng ƒêi·ªÉm")
        diem_icon.setStyleSheet("font-size:15px;color:#ff9800;font-weight:bold;")
        diem_icon.setAlignment(Qt.AlignCenter)
        diem_v.addWidget(diem_icon)
        self.diem_value = QLabel('69')
        self.diem_value.setStyleSheet("font-size:20px;font-weight:bold;color:#ff9800;")
        self.diem_value.setAlignment(Qt.AlignCenter)
        diem_v.addWidget(self.diem_value)
        stats_layout.addWidget(diem_box)
        sidebar_layout.addWidget(stats_frame)

        # Block tool buttons (x·∫øp 2 c·ªôt)
        tool_items = [
            ("üåÖ NG√ÄY M·ªöI", self.ngay_moi_all),
            ("üßæ ƒêƒÉng Nh·∫≠p T·∫•t C·∫£", self.login_all_accounts),
            ("üéÅ L√†m Nhi·ªám V·ª• T·∫•t C·∫£", self.run_all_tasks),
            ("üéÆ Ki·ªÉm Tra Proxy", self.check_proxy_all),
            ("üîÑ Thay Proxy Kh√¥ng Ho·∫°t ƒê·ªông", self.replace_dead_proxies),
            ("ü™ô L·∫•y ƒêi·ªÉm T·∫•t C·∫£", self.get_point_all),
            ("üì¢ ƒêi·ªÉm Danh T·∫•t C·∫£", self.diem_danh_all),
            ("üîó Ki·ªÉm Tra Li√™n K·∫øt", self.CheckCacLienKet),
            ("üóëÔ∏è X√≥a ACC B·ªã C·∫•m", self.delete_all_banned_accounts),
            ("üî¢ S·∫Øp X·∫øp Theo ƒêi·ªÉm", self.sort_by_point_and_save),
            ("üîë Thay M·∫≠t Kh·∫©u T·∫•t C·∫£", self.change_password_all),  # <-- Th√™m d√≤ng n√†y
        ]
        btn_grid = QGridLayout()
        btn_grid.setSpacing(8)
        btn_grid.setContentsMargins(0, 0, 0, 0)
        for idx, (text, func) in enumerate(tool_items):
            btn = QPushButton(text)
            btn.setStyleSheet("""
                QPushButton{
                    background:#fff3e0;
                    border-radius:10px;
                    padding:8px 5px;
                    font-size:12px;
                    text-align:left;
                    margin-bottom:4px;
                    font-weight:bold;
                    color:#ff9800;
                    min-height:20px;
                }
                QPushButton:hover{
                    background:#ffe0b2;
                }
            """)
            btn.setCursor(Qt.PointingHandCursor)
            btn.clicked.connect(func)
            row = idx // 2
            col = idx % 2
            btn_grid.addWidget(btn, row, col)
        sidebar_layout.addLayout(btn_grid)
        sidebar_layout.addStretch(1)

        # --- MAIN CONTENT ---
        content_widget = QWidget()
        content_layout = QVBoxLayout(content_widget)
        content_layout.setContentsMargins(24, 24, 24, 24)
        content_layout.setSpacing(18)
        # Table
        self.table = QTableWidget()
        self.table.setColumnCount(9)
        self.table.setHorizontalHeaderLabels([
            "Token", "Proxy", "T√†i kho·∫£n", "M·∫≠t kh·∫©u", "F-ID",
            "ƒêi·ªÉm", "Tr·∫°ng th√°i", "Ghi ch√∫","ƒêi·ªÉm Danh"
        ])
        self.table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.table.setAlternatingRowColors(True)
        self.table.setStyleSheet("QTableWidget::item:selected { background-color: #ADD8E6; }")
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(10)
        shadow.setColor(QColor(0, 0, 0, 160))
        shadow.setOffset(3, 3)
        self.table.setGraphicsEffect(shadow)
        self.table.setContextMenuPolicy(Qt.CustomContextMenu)
        self.table.customContextMenuRequested.connect(self.show_context_menu)
        self.table.horizontalHeader().setSectionResizeMode(QHeaderView.Interactive)
        self.table.setColumnWidth(0, 50)   # Token
        self.table.setColumnWidth(1, 50)   # Proxy
        self.table.setColumnWidth(2, 60)  # T√†i kho·∫£n
        self.table.setColumnWidth(3, 60)  # M·∫≠t kh·∫©u
        self.table.setColumnWidth(4, 60)   # F-ID
        self.table.setColumnWidth(5, 80)   # ƒêi·ªÉm
        # C·ªôt 6 (Tr·∫°ng th√°i) k√©o d√£n h·∫øt ph·∫ßn c√≤n l·∫°i
        self.table.horizontalHeader().setSectionResizeMode(6, QHeaderView.Stretch)
        self.table.setColumnWidth(7, 120)  # Ghi ch√∫
        self.table.setColumnWidth(8, 90)   # ƒêi·ªÉm Danh
        content_layout.addWidget(self.table)

        # Add to main layout
        main_layout.addWidget(self.sidebar)
        main_layout.addWidget(content_widget)

        # Floating menu button (‚ò∞) to show sidebar when hidden
        self.floating_menu_btn = QPushButton("‚ò∞", self)
        self.floating_menu_btn.setFixedSize(36, 36)
        self.floating_menu_btn.setStyleSheet("QPushButton{background:#fff3e0;border-radius:18px;font-size:22px;color:#ff9800;font-weight:bold;border:2px solid #ffe0b2;position: absolute; left: 8px; top: 16px;} QPushButton:hover{background:#ffe0b2;}")
        self.floating_menu_btn.move(8, 16)
        self.floating_menu_btn.hide()
        self.floating_menu_btn.clicked.connect(self.show_sidebar)

        self.timer = QTimer()
        self.timer.timeout.connect(self.update_totals)
        self.timer.start(1000)
        self.load_data()
        self.apply_light_theme()

    def show_context_menu(self, pos):
        menu = QMenu()
        login_action = menu.addAction("ƒêƒÉng Nh·∫≠p")
        get_point_action = menu.addAction("L·∫•y ƒëi·ªÉm")
        run_action = menu.addAction("L√†m Nhi·ªám V·ª•")
        lienket_action = menu.addAction("Li√™n K·∫øt T√†i Kho·∫£n Game")
        withdraw_action = menu.addAction("R√∫t ƒêi·ªÉm")
        set_pin_action = menu.addAction("üîê Set M√£ PIN")
        menu.addSeparator()  # Th√™m ƒë∆∞·ªùng ph√¢n c√°ch
        delete_action = menu.addAction("üóëÔ∏è X√≥a D√≤ng")
        # Th√™m ch·ª©c nƒÉng r√∫t full ƒëi·ªÉm cho acc ƒëang ch·ªçn
        rut_full_action = menu.addAction("üí∞ R√∫t Full ƒêi·ªÉm")
        action = menu.exec_(self.table.mapToGlobal(pos))
        if action == login_action:
            self.login_selected_account()
        elif action == get_point_action:
            self.get_point_selected()
        elif action == run_action:
            self.run_selected_task()
        elif action == lienket_action:
            self.LienKetTuyChon()
        elif action == withdraw_action:
            self.Thuanrutdiemday()
        elif action == set_pin_action:
            self.set_pin_selected()
        elif action == delete_action:
            self.delete_selected_row()
        elif action == rut_full_action:
            self.rut_full_diem_selected()

    def rut_full_diem_selected(self):
        """R√∫t full ƒëi·ªÉm cho acc ƒëang ch·ªçn (ch·ªâ 1 d√≤ng)"""
        from qtpy.QtWidgets import QDialog, QVBoxLayout, QLabel, QPushButton, QComboBox, QLineEdit, QMessageBox
        import threading
        row = self.table.currentRow()
        if row == -1:
            return
        # Danh s√°ch game m·∫´u
        game_list = [
            {"memberCode": "MOCBAI", "websiteName": "MB66", "id": "1739230912039436290"},
            {"memberCode": "OK9", "websiteName": "OK9", "id": "1798608608416931842"},
            {"memberCode": "78win", "websiteName": "78win", "id": "1814571722874535937"},
            {"memberCode": "QQ88", "websiteName": "QQ88", "id": "1863085503318499329"},
            {"memberCode": "F168", "websiteName": "F168", "id": "1863085976314355713"},
        ]
        dialog = QDialog(self)
        dialog.setWindowTitle("R√∫t Full ƒêi·ªÉm (1 acc)")
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #23243a, stop:1 #181928);
                color: #fff;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 16px;
                border-radius: 18px;
            }
            QLabel {
                color: #ffa726;
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 6px;
            }
            QLineEdit, QComboBox {
                padding: 12px 14px;
                border: 1.5px solid #444;
                border-radius: 10px;
                background-color: #23243a;
                color: #fff;
                font-size: 16px;
                margin-bottom: 12px;
            }
            QPushButton {
                background-color: #ffa726;
                padding: 14px 0;
                border: none;
                border-radius: 10px;
                font-weight: bold;
                color: #23243a;
                font-size: 18px;
                margin-top: 18px;
                margin-bottom: 8px;
            }
            QPushButton:hover {
                background-color: #ffb74d;
                color: #181928;
            }
        """)
        layout = QVBoxLayout(dialog)
        game_label = QLabel("Ch·ªçn Game:")
        layout.addWidget(game_label)
        game_combo = QComboBox()
        for game in game_list:
            game_combo.addItem(game['websiteName'], game)
        layout.addWidget(game_combo)
        pin_label = QLabel("Nh·∫≠p M√£ PIN:")
        layout.addWidget(pin_label)
        pin_input = QLineEdit()
        pin_input.setPlaceholderText("Nh·∫≠p m√£ PIN")
        layout.addWidget(pin_input)
        start_btn = QPushButton("B·∫Øt ƒê·∫ßu R√∫t Full ƒêi·ªÉm")
        layout.addWidget(start_btn)
        def start_rut_full():
            selected_game = game_combo.currentData()
            pin = pin_input.text().strip()
            if not pin:
                QMessageBox.warning(dialog, "L·ªói", "Vui l√≤ng nh·∫≠p m√£ PIN!")
                return
            dialog.accept()
            threading.Thread(target=self._rut_full_diem_thread_selected, args=(row, selected_game, pin), daemon=True).start()
        start_btn.clicked.connect(start_rut_full)
        if dialog.exec() == QDialog.Accepted:
            pass

    def _rut_full_diem_thread_selected(self, row, game_info, pin):
        import requests
        import hashlib
        import time
        from qtpy.QtWidgets import QTableWidgetItem
        def create_proxy(proxy_string):
            parts = proxy_string.split(":")
            ip = parts[0]
            port = parts[1]
            username = parts[2]
            password = parts[3]
            proxies = {
                "http": f"http://{username}:{password}@{ip}:{port}",
                "https": f"http://{username}:{password}@{ip}:{port}"
            }
            return proxies
        def calculate_withdraw_amounts(total_points):
            if total_points < 10:
                return []
            amounts = []
            remaining = total_points
            while remaining >= 10:
                if remaining >= 50:
                    amounts.append(50)
                    remaining -= 50
                else:
                    amounts.append(remaining)
                    remaining = 0
            return amounts
        try:
            point_item = self.table.item(row, 5)
            if not point_item:
                return
            try:
                current_points = int(point_item.text())
            except:
                current_points = 0
            if current_points < 10:
                self.table.setItem(row, 6, QTableWidgetItem("ƒêi·ªÉm kh√¥ng ƒë·ªß ƒë·ªÉ r√∫t (t·ªëi thi·ªÉu 10)"))
                return
            self.table.setItem(row, 6, QTableWidgetItem(f"B·∫Øt ƒë·∫ßu r√∫t full {current_points} ƒëi·ªÉm..."))
            total_withdrawn = 0
            remaining_points = current_points
            i = 0
            while remaining_points >= 10:
                if remaining_points >= 50:
                    amount = 50
                else:
                    amount = remaining_points
                retry_count = 0
                while True:
                    self.table.setItem(row, 6, QTableWidgetItem(f"R√∫t l·∫ßn {i+1}: {amount} ƒëi·ªÉm... (th·ª≠ {retry_count+1})"))
                    token = self.table.item(row, 0).text()
                    proxy = self.table.item(row, 1).text()
                    f_id = self.table.item(row, 4).text()
                    if not token or token.strip() == "":
                        self.table.setItem(row, 6, QTableWidgetItem("Token tr·ªëng!"))
                        return
                    headers = {
                        "accept": "application/json, text/plain, */*",
                        "content-type": "application/json",
                        "f-id": f_id,
                        "locale": "vi_vn",
                        "referer": "https://m.oklavip26.live/wallet?type=0",
                        "token": token,
                        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
                    }
                    pin_md5 = hashlib.md5(pin.encode('utf-8')).hexdigest()
                    data = {
                        "withdrawPoint": str(amount),
                        "withdrawPassword": pin_md5,
                        "websiteId": game_info["id"],
                        "memberCode": game_info["memberCode"]
                    }
                    proxies = create_proxy(proxy)
                    try:
                        response = requests.post(
                            "https://m.oklavip26.live/api/withdrawRecord/withdraw",
                            headers=headers,
                            json=data,
                            proxies=proxies,
                            timeout=15
                        )
                        if response.status_code == 200:
                            resp_data = response.json()
                            if resp_data.get("code") == 200:
                                total_withdrawn += amount
                                remaining_points -= amount
                                self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ R√∫t {amount} ƒëi·ªÉm th√†nh c√¥ng (l·∫ßn {i+1})"))
                                time.sleep(2)
                                break  # Th√†nh c√¥ng, sang l·∫ßn ti·∫øp theo
                            else:
                                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói: {resp_data.get('message', 'Kh√¥ng r√µ')} (th·ª≠ l·∫°i)") )
                        else:
                            self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå HTTP {response.status_code} (th·ª≠ l·∫°i)"))
                    except Exception as e:
                        self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå Exception: {str(e)} (th·ª≠ l·∫°i)"))
                    retry_count += 1
                    time.sleep(1)
                self.table.setItem(row, 5, QTableWidgetItem(str(remaining_points)))
                # L∆∞u l·∫°i v√†o file ACC.txt
                self.save_row_to_file(row)
                i += 1
            if total_withdrawn > 0:
                self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ ƒê√£ r√∫t h·∫øt: {total_withdrawn}/{current_points} ƒëi·ªÉm"))
            else:
                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå Kh√¥ng r√∫t ƒë∆∞·ª£c ƒëi·ªÉm n√†o!"))
            time.sleep(1)
        except Exception as e:
            self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói x·ª≠ l√Ω: {str(e)}"))
            return

    def login_selected_account(self):
        row = self.table.currentRow()
        if row == -1:
            return
        self.is_login_all = False
        account = self.table.item(row, 2).text()
        password = self.password_map.get(row)
        f_id = self.table.item(row, 4).text()
        proxy_string = self.table.item(row, 1).text()
        token = self.table.item(row, 0).text() if self.table.item(row, 0) else ""
        worker = LoginWorker(row, account, password, f_id, proxy_string, token)
        worker.signals.update_status.connect(self.update_status)
        worker.signals.login_result.connect(self.handle_login_result)
        self.threadpool.start(worker)

    def login_all_accounts(self):
        self.is_login_all = True
        for row in range(self.table.rowCount()):
            account = self.table.item(row, 2).text()
            password = self.password_map.get(row)
            f_id = self.table.item(row, 4).text()
            proxy_string = self.table.item(row, 1).text()
            token = self.table.item(row, 0).text() if self.table.item(row, 0) else ""
            worker = LoginWorker(row, account, password, f_id, proxy_string, token)
            worker.signals.update_status.connect(self.update_status)
            worker.signals.login_result.connect(self.handle_login_result)
            self.threadpool.start(worker)

    def update_status(self, row, status):
        self.table.setItem(row, 6, QTableWidgetItem(status))
        print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: {status}")

    def handle_login_result(self, row, token, result, diem, error_msg):
        if result == "DONE":
            self.table.setItem(row, 0, QTableWidgetItem(token))
            print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: ƒêƒÉng nh·∫≠p th√†nh c√¥ng!")
            # C·∫≠p nh·∫≠t to√†n b·ªô d√≤ng v√†o file ACC.txt
            if self.save_row_to_file(row):
                print(f"[LOG] ƒê√£ c·∫≠p nh·∫≠t to√†n b·ªô d√≤ng v√†o file ACC.txt cho d√≤ng {row}")
            if not self.is_login_all:
                QMessageBox.information(self, "ƒêƒÉng nh·∫≠p", f"ƒêƒÉng nh·∫≠p th√†nh c√¥ng cho t√†i kho·∫£n {self.table.item(row,2).text()}.")
        elif result == "TOKEN_OK":
            # Token c√≤n s·ªëng, ch·ªâ update ƒëi·ªÉm
            if diem is not None:
                self.table.setItem(row, 5, QTableWidgetItem(str(diem)))
                print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: Token s·ªëng, ƒëi·ªÉm: {diem}")
        elif result == "GET_POINT_OK":
            if diem is not None:
                self.table.setItem(row, 5, QTableWidgetItem(str(diem)))
                print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: L·∫•y ƒëi·ªÉm th√†nh c√¥ng: {diem}")
                # L∆∞u l·∫°i d√≤ng v√†o file ACC.txt
                if self.save_row_to_file(row):
                    print(f"[LOG] ƒê√£ l∆∞u d√≤ng v√†o file ACC.txt sau khi l·∫•y ƒëi·ªÉm cho d√≤ng {row}")
        elif result == "GET_POINT_FAIL":
            print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: L·∫•y ƒëi·ªÉm th·∫•t b·∫°i!")
        else:
            print(f"[LOG] Row {row} - {self.table.item(row,2).text()}: ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!")
            msg = f"Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p t√†i kho·∫£n {self.table.item(row,2).text()}"
            if error_msg:
                self.table.setItem(row, 6, QTableWidgetItem(f"L·ªói: {error_msg}"))
                msg += f"\n\nL√Ω do: {error_msg}"
            if not self.is_login_all:
                QMessageBox.critical(self, "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", msg)

    def update_totals(self):
        total_diem = 0
        for row in range(self.table.rowCount()):
            try:
                total_diem += int(self.table.item(row, 5).text())
            except:
                continue
        # C·∫≠p nh·∫≠t label ·ªü sidebar
        self.diem_value.setText(str(total_diem))
        self.acc_value.setText(str(self.table.rowCount()))

    def load_data(self):
        if not os.path.exists(FILE_PATH): return
        with open(FILE_PATH, "r", encoding="utf-8") as f:
            lines = f.readlines()
        self.table.setRowCount(len(lines))
        for row, line in enumerate(lines):
            cells = line.strip().split("|")
            while len(cells) < 8:
                cells.append("")
            for col, text in enumerate(cells):
                item = QTableWidgetItem(text)
                item.setTextAlignment(Qt.AlignCenter)
                self.table.setItem(row, col, item)
            self.password_map[row] = cells[3]

    def get_point_selected(self):
        row = self.table.currentRow()
        if row == -1:
            return
        token = self.table.item(row, 0).text() if self.table.item(row, 0) else ""
        f_id = self.table.item(row, 4).text()
        proxy_string = self.table.item(row, 1).text()
        worker = GetPointWorker(row, token, f_id, proxy_string)
        worker.signals.update_status.connect(self.update_status)
        worker.signals.login_result.connect(self.handle_login_result)
        self.threadpool.start(worker)

    def get_point_all(self):
        for row in range(self.table.rowCount()):
            token = self.table.item(row, 0).text() if self.table.item(row, 0) else ""
            f_id = self.table.item(row, 4).text()
            proxy_string = self.table.item(row, 1).text()
            worker = GetPointWorker(row, token, f_id, proxy_string)
            worker.signals.update_status.connect(self.update_status)
            worker.signals.login_result.connect(self.handle_login_result)
            self.threadpool.start(worker)

    def run_selected_task(self):
        row = self.table.currentRow()
        if row == -1:
            return
        threading.Thread(target=self.ChAyAll, args=(row,), daemon=True).start()

    def ChAyAll(self, row):
        try:
            import time
            self.table.setItem(row, 6, QTableWidgetItem(f"B·∫Øt ƒê·∫ßu"))
            self.table.setItem(row, 6, QTableWidgetItem(f"Check Token"))
            chechDangNhap = self.CheckLoginssssss(row)
            print(chechDangNhap)
            if chechDangNhap:
                self.table.setItem(row, 6, QTableWidgetItem(f"B·∫Øt Tr·∫£ L·ªùi C√¢u H·ªèi"))
                self.CheckLuotTraLoiall(row)
                self.table.setItem(row, 6, QTableWidgetItem(f"B·∫Øt Quay Ch·ªØ"))
                self.CheckGhepChuall(row)
                self.table.setItem(row, 6, QTableWidgetItem(f"‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è‚òëÔ∏è"))
            else:
                self.table.setItem(row, 6, QTableWidgetItem(f"[üí©üí©üí©]> Token Ch·∫øt M·∫∏ R·ªìi em!"))
        except Exception as e:
            self.table.setItem(row, 6, QTableWidgetItem(f"[üí©üí©üí©]> L·ªói C√°i Ch√≥ G√¨ √Å T·ª± Check !"))

    def CheckLoginssssss(self, row):
        # Dummy check: token ph·∫£i kh√°c r·ªóng v√† kh√¥ng ph·∫£i 'die' (b·∫°n thay b·∫±ng API check th·∫≠t n·∫øu c√≥)
        token = self.table.item(row, 0).text() if self.table.item(row, 0) else ""
        return bool(token and token.lower() != 'die')

    def CheckLuotTraLoiall(self, selected_row):
        import random, time, requests
        def lay_answer_list():
            if not hasattr(lay_answer_list, "shuffled_answers") or lay_answer_list.index >= len(lay_answer_list.shuffled_answers):
                all_answers = [
                    {"id":"1832015410311356418","submitAnswer":"A"},
                    {"id":"1824037680311590913","submitAnswer":"A"},
                    {"id":"1921122479935578114","submitAnswer":"C"},
                    {"id":"1935963950826205186","submitAnswer":"C"},
                    {"id":"1818957396713062402","submitAnswer":"C"},
                    {"id":"1832916040299208705","submitAnswer":"C"},
                    {"id":"1743646382914015234","submitAnswer":"D"},
                    {"id":"1785518703386198017","submitAnswer":"A"},
                    {"id":"1894536554099724290","submitAnswer":"A"},
                    {"id":"1935964127186984962","submitAnswer":"B"}
                ]
                random.shuffle(all_answers)
                lay_answer_list.shuffled_answers = all_answers
                lay_answer_list.index = 0
            start = lay_answer_list.index
            end = start + 5
            result = lay_answer_list.shuffled_answers[start:end]
            lay_answer_list.index += 5
            return result
        token = self.table.item(selected_row, 0).text()
        proxy = self.table.item(selected_row, 1).text()
        f_id = self.table.item(selected_row, 4).text()
        self.table.setItem(selected_row, 6, QTableWidgetItem("B·∫Øt ƒë·∫ßu ki·ªÉm tra"))
        try:
            proxy_url, port, username, password = proxy.split(':')
            proxy_address = f"http://{username}:{password}@{proxy_url}:{port}"
            proxies = {"http": proxy_address, "https": proxy_address}
            headers = {
                "authority": "m.oklavip26.live",
                "accept": "application/json, text/plain, */*",
                "accept-language": "vi-VN,vi;q=0.9",
                "content-type": "application/json",
                "locale": "vi_vn",
                "origin": "https://m.oklavip26.live",
                "priority": "u=1, i",
                "sec-ch-ua": '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": "Windows",
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-origin",
                "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                "f-id": f_id,
                "token": token,
                "cache-control": "no-cache",
                "pragma": "no-cache",
                "referer": "https://m.oklavip26.live/",
            }
            response = requests.get(
                "https://m.oklavip26.live/api/activityQuestion/getActivityQuestionInfo",
                headers=headers, proxies=proxies, timeout=500).json()
            luot = response['data']['surplusNumber']
            self.table.setItem(selected_row, 6, QTableWidgetItem(f"C√≤n {luot} l∆∞·ª£t"))
            for cac in range(int(luot)):
                DanhSachCauHoi = requests.get('https://m.oklavip26.live/api/activityQuestion/getQuestionList',headers=headers, proxies=proxies, timeout=500).json()['data']
                delay_time = random.randint(20, 30)
                for delay in range(delay_time, -1, -1):
                    self.table.setItem(selected_row, 6, QTableWidgetItem(f"Delay {delay}"))
                    time.sleep(1)
                date_time = int(time.time())
                recordNo = requests.get('https://m.oklavip26.live/api/activityQuestion/startAnswerQuestion',headers=headers, proxies=proxies, timeout=500).json()['data']['recordNo']
                dataTraloi = {
                    "answerList": lay_answer_list(),
                    "timeStart": date_time,
                    "recordNo": recordNo
                }
                response = requests.post('https://m.oklavip26.live/api/activityQuestion/submitQuestion',headers=headers,json=dataTraloi, proxies=proxies, timeout=500)
                print(response.json())
                time.sleep(3)
            CheckLuotQuay=requests.get("https://m.oklavip26.live/api/lottery/getLuckyDrawBaseInfo",headers=headers , proxies=proxies , timeout=500).json()
            data2 = {"raffleId": CheckLuotQuay['data']['raffleId']}
            CheckLuotQuay=requests.post("https://m.oklavip26.live/api/lottery/getLuckyDrawInfoByDaily",headers=headers , proxies=proxies , timeout=500).json()['data']['drawCount']
            for xx in range(int(CheckLuotQuay)):
                prize_response = requests.post("https://m.oklavip26.live/api/lottery/lotteryByDaily",headers=headers, json=data2 , proxies=proxies , timeout=500).json()
                prize_name = prize_response.get('data', {}).get('prizeInfo', {}).get('prizeName', 'Kh√¥ng r√µ')
                delay_time = random.randint(5,6)
                for delay in range(delay_time, -1, -1):
                    self.table.setItem(selected_row, 6, QTableWidgetItem(f"Delay {delay} | üéÅ {prize_name}"))
                    time.sleep(1)
                # Th√¥ng b√°o ngay khi nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng
                self.table.setItem(selected_row, 6, QTableWidgetItem(f"üéâ Nh·∫≠n ƒë∆∞·ª£c: {prize_name}"))
            self.table.setItem(selected_row, 6, QTableWidgetItem(f"Xong!"))
        except Exception as e:
            self.table.setItem(selected_row, 6, QTableWidgetItem(f"L·ªói ki·ªÉm tra l∆∞·ª£t: {str(e)}"))

    def CheckGhepChuall(self, selected_row):
        import requests, time
        row = selected_row
        token = self.table.item(row, 0).text()
        proxy = self.table.item(row, 1).text()
        f_id = self.table.item(row, 4).text()
        proxy_url, port, username, password = proxy.split(':')
        proxy_address = f"http://{username}:{password}@{proxy_url}:{port}"
        proxies = {
            "http": proxy_address,
            "https": proxy_address
        }
        headers = {
            "authority": "m.oklavip26.live",
            "accept": "application/json, text/plain, */*",
            "accept-language": "vi-VN,vi;q=0.9",
            "content-type": "application/json",
            "locale": "vi_vn",
            "origin": "https://m.oklavip26.live",
            "priority": "u=1, i",
            "sec-ch-ua": '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "Windows",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
            "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
            "f-id": f_id,
            "token": token,
            "cache-control": "no-cache",
            "pragma": "no-cache",
            "referer": "https://m.oklavip26.live/",
        }
        try:
            response = requests.get('https://m.oklavip26.live/api/activityCollect/getListAvailable', headers=headers, proxies=proxies, timeout=500).json()
            idGame = response['data'][0]['id']
            data = {"id": idGame}
            draw_response = requests.post("https://m.oklavip26.live/api/activityCollect/get", headers=headers, json=data, proxies=proxies, timeout=500).json()
            draw_times = draw_response['data']['drawTimes']
            status_text = f"L∆∞·ª£t gh√©p ch·ªØ c√≤n l·∫°i: {draw_times}"
            self.table.setItem(selected_row, 6, QTableWidgetItem(status_text))
            for _ in range(int(draw_times)):
                response = requests.post('https://m.oklavip26.live/api/activityCollect/drawWord', headers=headers, json=data, proxies=proxies, timeout=500)
                for delay in range(5,-1,-1):
                    self.table.setItem(selected_row, 6, QTableWidgetItem(f"Delay {delay} [{response.json()['data']['textName']}]") )
                    time.sleep(1)
            response = requests.post("https://m.oklavip26.live/api/activityCollect/get", headers=headers, json=data, proxies=proxies, timeout=500)
            synthesisTimes = response.json()['data']['synthesisTimes']
            data2 = {"raffleId": requests.get("https://m.oklavip26.live/api/activityCollect/getListAvailable", headers=headers, proxies=proxies, timeout=500).json()['data'][0]['lotteryId']}
            for _ in range(int(synthesisTimes)):
                response = requests.post('https://m.oklavip26.live/api/activityCollect/mergeWord', headers=headers, json=data, proxies=proxies, timeout=500)
                response2 = requests.post('https://m.oklavip26.live/api/lottery/lottery', headers=headers, json=data2, proxies=proxies, timeout=500)
                for delay in range(5,-1,-1):
                    self.table.setItem(selected_row, 6, QTableWidgetItem(f"Delay {delay} [{response2.json()['data']['prizeInfo']['prizeName']}]") )
                    time.sleep(1)
            self.table.setItem(selected_row, 6, QTableWidgetItem(f"Gh√©p Ch·ªØ Ho√†n T·∫•t!"))
        except Exception as e:
            self.table.setItem(selected_row, 6, QTableWidgetItem(f"L·ªói gh√©p ch·ªØ: {str(e)}"))

    def run_all_tasks(self):
        import threading
        from concurrent.futures import ThreadPoolExecutor, as_completed

        def pool_worker():
            def run_task(row):
                self.ChAyAll(row)

            max_workers = self.thread_spinbox.value()
            with ThreadPoolExecutor(max_workers=max_workers) as executor:
                futures = [executor.submit(run_task, row) for row in range(self.table.rowCount())]
                for future in as_completed(futures):
                    pass

        threading.Thread(target=pool_worker, daemon=True).start()

    def check_proxy_all(self):
        threading.Thread(target=self._check_proxy_thread, daemon=True).start()

    def _check_proxy_thread(self):
        from concurrent.futures import ThreadPoolExecutor, as_completed
        import requests
        from qtpy.QtWidgets import QTableWidgetItem, QDialog, QVBoxLayout, QTextEdit, QLabel, QPushButton
        import time
        proxy_errors = []
        lock = threading.Lock()
        def xu_ly_row(row):
            proxy = self.table.item(row, 1).text()
            self.table.setItem(row, 6, QTableWidgetItem(f"[XXX] Ki·ªÉm Tra M·∫°ng M√°y!"))
            def kiem_tra_mang():
                for lan in range(3):
                    try:
                        requests.get("https://www.google.com", timeout=10)
                        return True
                    except requests.RequestException:
                        self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå M√°y t√≠nh kh√¥ng c√≥ k·∫øt n·ªëi m·∫°ng. Th·ª≠ l·∫°i l·∫ßn {lan + 1}"))
                return False
            def kiem_tra_proxy(proxy_str):
                try:
                    ip, port, user, password = proxy_str.split(":")
                    proxy_url = f"http://{user}:{password}@{ip}:{port}"
                    proxies = {"http": proxy_url, "https": proxy_url}
                    response = requests.get("https://geo.myip.link/", proxies=proxies, timeout=10)
                    if response.status_code == 200:
                        return True, response.json()
                    else:
                        return False, f"L·ªói m√£ tr·∫°ng th√°i HTTP: {response.status_code}"
                except Exception as e:
                    return False, str(e)
            if kiem_tra_mang():
                self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ M·∫°ng ho·∫°t ƒë·ªông."))
                thanh_cong, ket_qua = kiem_tra_proxy(proxy)
                if thanh_cong:
                    self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ Proxy ho·∫°t ƒë·ªông. "))
                else:
                    self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå Proxy kh√¥ng ho·∫°t ƒë·ªông. "))
                    with lock:
                        proxy_errors.append((row, proxy, ket_qua))
                    # L∆∞u l·∫°i d√≤ng l·ªói v√†o ACC.txt
                    try:
                        acc_file = FILE_PATH
                        with self.file_lock:
                            # ƒê·ªçc t·ª´ file g·ªëc tr∆∞·ªõc
                            if os.path.exists(acc_file):
                                with open(acc_file, "r", encoding="utf-8") as f:
                                    lines = f.readlines()
                            else:
                                lines = []
                            
                            # T·∫°o file t·∫°m v√† ghi d·ªØ li·ªáu
                            tmp_file = acc_file + ".tmp"
                            if 0 <= row < len(lines):
                                new_cells = []
                                for col in range(self.table.columnCount()):
                                    item = self.table.item(row, col)
                                    new_cells.append(item.text() if item else "")
                                if len(new_cells) < 8:
                                    new_cells += [""] * (8 - len(new_cells))
                                lines[row] = "|".join(new_cells) + "\n"
                            
                            with open(tmp_file, "w", encoding="utf-8") as f:
                                f.writelines(lines)
                                f.flush()
                                os.fsync(f.fileno())
                            os.replace(tmp_file, acc_file)
                    except Exception as e:
                        print(f"[LOG] L·ªói l∆∞u d√≤ng proxy l·ªói v√†o file ACC.txt: {e}")
            else:
                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå M√°y t√≠nh kh√¥ng c√≥ k·∫øt n·ªëi m·∫°ng."))
        with ThreadPoolExecutor(max_workers=30) as executor:
            futures = [executor.submit(xu_ly_row, row) for row in range(self.table.rowCount())]
            for future in as_completed(futures):
                pass
        # Hi·ªán popup b√°o proxy l·ªói
        if proxy_errors:
            def show_error_dialog():
                dialog = QDialog(self)
                dialog.setWindowTitle("Danh s√°ch proxy l·ªói")
                layout = QVBoxLayout(dialog)
                label = QLabel(f"T·ªïng s·ªë proxy l·ªói: {len(proxy_errors)}")
                layout.addWidget(label)
                textedit = QTextEdit()
                textedit.setReadOnly(True)
                textedit.setMinimumWidth(400)
                textedit.setMinimumHeight(200)
                textedit.setText("\n".join([f"{row+1}: {proxy} - {err}" for row, proxy, err in proxy_errors]))
                layout.addWidget(textedit)
                btn = QPushButton("ƒê√≥ng")
                btn.clicked.connect(dialog.accept)
                layout.addWidget(btn)
                # CSS ƒë·∫πp cho dialog
                dialog.setStyleSheet('''
                    QDialog {
                        background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #4f8cff, stop:1 #8f5cff);
                        border-radius: 18px;
                    }
                    QLabel {
                        color: white;
                        font-size: 18px;
                        font-weight: bold;
                        padding: 16px 8px 8px 8px;
                    }
                    QPushButton {
                        background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #6faaff, stop:1 #3a6cff);
                        color: white;
                        border-radius: 12px;
                        padding: 8px 24px;
                        font-size: 15px;
                        font-weight: bold;
                        border: none;
                        margin-bottom: 12px;
                    }
                    QPushButton:hover {
                        background: #2353ff;
                    }
                ''')
                dialog.exec_()
            QTimer.singleShot(0, lambda: show_error_dialog())
            # L∆∞u l·∫°i proxy l·ªói cho ch·ª©c nƒÉng thay proxy
            self._last_proxy_errors = proxy_errors
        else:
            self._last_proxy_errors = []

    def replace_dead_proxies(self):
        # T√¨m l·∫°i proxy l·ªói t·ª´ l·∫ßn ki·ªÉm tra g·∫ßn nh·∫•t
        if not hasattr(self, '_last_proxy_errors') or not self._last_proxy_errors:
            QMessageBox.information(self, "Th√¥ng b√°o", "B·∫°n c·∫ßn ki·ªÉm tra proxy tr∆∞·ªõc khi thay proxy l·ªói!")
            return
        from qtpy.QtWidgets import QDialog, QVBoxLayout, QTextEdit, QLabel, QPushButton
        proxy_errors = self._last_proxy_errors
        dialog = QDialog(self)
        dialog.setWindowTitle("Thay Proxy Kh√¥ng Ho·∫°t ƒê·ªông")
        layout = QVBoxLayout(dialog)
        label = QLabel(f"Nh·∫≠p {len(proxy_errors)} proxy m·ªõi, m·ªói proxy 1 d√≤ng, ƒë√∫ng th·ª© t·ª±:")
        layout.addWidget(label)
        textedit = QTextEdit()
        textedit.setMinimumWidth(400)
        textedit.setMinimumHeight(200)
        layout.addWidget(textedit)
        btn = QPushButton("Thay th·∫ø")
        layout.addWidget(btn)
        def on_replace():
            new_proxies = [line.strip() for line in textedit.toPlainText().splitlines() if line.strip()]
            if len(new_proxies) != len(proxy_errors):
                QMessageBox.warning(dialog, "L·ªói", f"B·∫°n ph·∫£i nh·∫≠p ƒë√∫ng {len(proxy_errors)} proxy!")
                return
            # Thay v√†o b·∫£ng v√† file ACC.txt
            acc_file = FILE_PATH
            with self.file_lock:
                # ƒê·ªçc t·ª´ file g·ªëc tr∆∞·ªõc
                if os.path.exists(acc_file):
                    with open(acc_file, "r", encoding="utf-8") as f:
                        lines = f.readlines()
                else:
                    lines = []
                
                for idx, (row, old_proxy, err) in enumerate(proxy_errors):
                    proxy = new_proxies[idx]
                    # Update b·∫£ng
                    self.table.setItem(row, 1, QTableWidgetItem(proxy))
                    # Update file
                    if 0 <= row < len(lines):
                        cells = lines[row].strip().split("|")
                        if len(cells) < 8:
                            cells += [""] * (8 - len(cells))
                        cells[1] = proxy
                        lines[row] = "|".join(cells) + "\n"
                
                tmp_file = acc_file + ".tmp"
                with open(tmp_file, "w", encoding="utf-8") as f:
                    f.writelines(lines)
                    f.flush()
                    os.fsync(f.fileno())
                os.replace(tmp_file, acc_file)
            QMessageBox.information(dialog, "Th√†nh c√¥ng", "ƒê√£ thay proxy m·ªõi cho c√°c d√≤ng l·ªói!")
            dialog.accept()
        btn.clicked.connect(on_replace)
        dialog.exec_()

    def diem_danh_all(self):
        from concurrent.futures import ThreadPoolExecutor, as_completed
        import requests
        from qtpy.QtWidgets import QTableWidgetItem
        from qtpy.QtCore import QDate
        def chay_20_mot_luot():
            def xu_ly_row(row):
                token = self.table.item(row, 0).text()
                proxy = self.table.item(row, 1).text()
                Fidd = self.table.item(row, 4).text()
                url = "https://m.oklavip26.live/api/activitySignIn/singIn"
                headers = {
                    "authority": "m.oklavip26.live",
                    "accept": "application/json, text/plain, */*",
                    "accept-language": "vi-VN,vi;q=0.9",
                    "content-type": "application/json",
                    "locale": "vi_vn",
                    "origin": "https://m.oklavip26.live",
                    "priority": "u=1, i",
                    "referer": "https://m.oklavip26.live/login",
                    "sec-ch-ua": '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": "Windows",
                    "sec-fetch-dest": "empty",
                    "sec-fetch-mode": "cors",
                    "sec-fetch-site": "same-origin",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                    "f-id": Fidd,
                    "token": token
                }
                self.table.setItem(row, 6, QTableWidgetItem(f"ƒêi·ªÉm Danhhhhhhhhhhhhhhh"))
                try:
                    proxy_url, port, username, password = proxy.split(':')
                    proxy_address = f"http://{username}:{password}@{proxy_url}:{port}"
                    proxies = {
                        "http": proxy_address,
                        "https": proxy_address
                    }
                except Exception as e:
                    self.table.setItem(row, 6, QTableWidgetItem(f"Proxy l·ªói: {e}"))
                    return
                chechDangNhap = self.CheckLoginssssss(row)
                print(chechDangNhap)
                if chechDangNhap:
                    try:
                        response = requests.post(url, headers=headers, proxies=proxies, timeout=500)
                        print(response.text)
                        if response.status_code == 200 and response.json().get("code") == 200:
                            data = response.json().get("data", {})
                            status = data.get("status")
                            continue_days = data.get("continueDays")
                            if status == 2 or continue_days is None:
                                self.table.setItem(row, 6, QTableWidgetItem(f"ƒê√£ ƒëi·ªÉm danh h√¥m nay ho·∫∑c kh√¥ng th·ªÉ ƒëi·ªÉm danh!"))
                            else:
                                aaaaaaaaaaaa = continue_days
                                requests.get("https://m.oklavip26.live/api/accountLogin/updateOnline", headers=headers, proxies=proxies, timeout=500)
                                self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ ƒê√£ ƒêi·ªÉm Danh Th√†nh C√¥ng: {aaaaaaaaaaaa}"))
                                try:
                                    aaaaaaaaaaaa = int(aaaaaaaaaaaa)
                                    from qtpy.QtCore import QDate
                                    current_date = QDate.currentDate()
                                    formatted_date = current_date.toString("dd/MM")
                                    self.table.setItem(row, 8, QTableWidgetItem(formatted_date+f"[{aaaaaaaaaaaa}]"))
                                except Exception as e:
                                    print(f"L·ªói c·∫≠p nh·∫≠t c·ªôt ƒëi·ªÉm danh: {e}")
                                # L∆∞u l·∫°i d√≤ng acc n√†y v√†o file ACC.txt
                                if self.save_row_to_file(row):
                                    print(f"[LOG] ƒê√£ l∆∞u d√≤ng v√†o file ACC.txt sau khi ƒëi·ªÉm danh cho d√≤ng {row}")
                        else:
                            msg = response.json().get("message", "L·ªói kh√¥ng r√µ")
                            self.table.setItem(row, 6, QTableWidgetItem(f"L·ªói ƒëi·ªÉm danh: {msg}"))
                    except Exception as e:
                        self.table.setItem(row, 6, QTableWidgetItem(f"L·ªói ƒëi·ªÉm danh: {e}"))
                else:
                    self.table.setItem(row, 6, QTableWidgetItem(f"[üí©]> Token Ch·∫øt M·∫∏ R·ªìi em! <[üí©]"))
            with ThreadPoolExecutor(max_workers=50) as executor:
                futures = [executor.submit(xu_ly_row, row) for row in range(self.table.rowCount())]
                for future in as_completed(futures):
                    pass
        chay_20_mot_luot()

    def LienKetTuyChon(self):
        # Danh s√°ch game m·∫´u
        game_list = [
            {"memberCode": "MOCBAI", "websiteName": "MB66", "id": "1739230912039436290"},
            {"memberCode": "OK9", "websiteName": "OK9", "id": "1798608608416931842"},
            {"memberCode": "78win", "websiteName": "78win", "id": "1814571722874535937"},
            {"memberCode": "QQ88", "websiteName": "QQ88", "id": "1863085503318499329"},
            {"memberCode": "F168", "websiteName": "F168", "id": "1863085976314355713"},
        ]
        dialog = GameInputDialog(game_list, "Li√™n K·∫øt T√†i Kho·∫£n", "User", "S·ªë ƒêi·ªán Tho·∫°i")
        if dialog.exec():
            game_info = dialog.selected_game
            game_account = dialog.game_account
            game_phone = dialog.game_phone
        else:
            return
        row = self.table.currentRow()
        if row == -1:
            return
        # L·∫•y d·ªØ li·ªáu acc ƒëang ch·ªçn
        token = self.table.item(row, 0).text()
        proxy = self.table.item(row, 1).text()
        tkkk = self.table.item(row, 2).text()
        password = self.password_map.get(row)
        f_id = self.table.item(row, 4).text()
        acc = [token, proxy, tkkk, password, f_id]
        # Ch·∫°y li√™n k·∫øt tr√™n thread
        self.thuan_lienket_thread = ThuanLienKet([row], [acc], game_info, game_account, game_phone, self)
        self.thuan_lienket_thread.result.connect(self.handle_lienket_tuychon_result)
        self.thuan_lienket_thread.start()

    def handle_lienket_tuychon_result(self, row, message):
        self.table.setItem(row, 6, QTableWidgetItem(message))

    def Thuanrutdiemday(self):
        import hashlib
        game_list = [
            {"memberCode": "MOCBAI", "websiteName": "MB66", "id": "1739230912039436290"},
            {"memberCode": "OK9", "websiteName": "OK9", "id": "1798608608416931842"},
            {"memberCode": "78win", "websiteName": "78win", "id": "1814571722874535937"},
            {"memberCode": "QQ88", "websiteName": "QQ88", "id": "1863085503318499329"},
            {"memberCode": "F168", "websiteName": "F168", "id": "1863085976314355713"},
        ]
        dialog = GameInputDialog(game_list, "R√∫t ƒêi·ªÉm", "S·ªë ƒêi·ªÉm Mu·ªën R√∫t", "M√£ PIN")
        if dialog.exec():
            game_info = dialog.selected_game
            game_account = dialog.game_account
            game_phone = dialog.game_phone
        else:
            return
        row = self.table.currentRow()
        if row == -1:
            return
        token = self.table.item(row, 0).text()
        proxy = self.table.item(row, 1).text()
        tkkk = self.table.item(row, 2).text()
        password = self.password_map.get(row)
        f_id = self.table.item(row, 4).text()
        acc = [token, proxy, tkkk, password, f_id]
        self.thuan_lienket_thread = Thuanrutdiem([row], [acc], game_info, game_account, game_phone, self)
        self.thuan_lienket_thread.result.connect(self.handle_lienket_tuychon_result)
        self.thuan_lienket_thread.start()

    def delete_selected_row(self):
        row = self.table.currentRow()
        if row == -1:
            return
        # X√≥a d√≤ng t·ª´ b·∫£ng
        self.table.removeRow(row)
        # X√≥a d√≤ng t·ª´ file ACC.txt
        try:
            acc_file = FILE_PATH
            with self.file_lock:
                # ƒê·ªçc t·ª´ file g·ªëc tr∆∞·ªõc
                if os.path.exists(acc_file):
                    with open(acc_file, "r", encoding="utf-8") as f:
                        lines = f.readlines()
                else:
                    lines = []
                
                # X√≥a d√≤ng v√† ghi l·∫°i
                if 0 <= row < len(lines):
                    lines.pop(row)
                    tmp_file = acc_file + ".tmp"
                    with open(tmp_file, "w", encoding="utf-8") as f:
                        f.writelines(lines)
                        f.flush()
                        os.fsync(f.fileno())
                    os.replace(tmp_file, acc_file)
                print(f"[LOG] ƒê√£ x√≥a d√≤ng v√†o file ACC.txt cho d√≤ng {row}")
        except Exception as e:
            print(f"[LOG] L·ªói x√≥a d√≤ng v√†o file ACC.txt: {e}")

    def set_pin_selected(self):
        row = self.table.currentRow()
        if row == -1:
            return
        threading.Thread(target=self.SetMaPinChoTaiKhoan, args=(row,), daemon=True).start()

    def SetMaPinChoTaiKhoan(self, row):
        try:
            token = self.table.item(row, 0).text()
            proxy = self.table.item(row, 1).text()
            f_id = self.table.item(row, 4).text()

            # D·ªØ li·ªáu g·ª≠i: m√£ PIN l√† MD5 c·ªßa "1234"
            payload = {
                "newWithdrawPassword": "4297f44b13955235245b2497399d7a93",
                "confirmWithdrawPassword": "4297f44b13955235245b2497399d7a93"
            }

            headers = {
                "accept": "application/json, text/plain, */*",
                "content-type": "application/json",
                "locale": "vi_vn",
                "referer": "https://m.okvip19.live/setWithDrawalpass",
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                "f-id": f_id,
                "token": token
            }

            # X·ª≠ l√Ω th√¥ng tin proxy
            proxy_url, port, username, password = proxy.split(':')
            proxy_address = f"http://{username}:{password}@{proxy_url}:{port}"
            proxies = {
                "http": proxy_address,
                "https": proxy_address
            }

            # URL API
            url = "https://m.okvip19.live/api/account/setWithdrawPassword"
            response = requests.post(url, headers=headers, json=payload, proxies=proxies, timeout=15)

            # Ki·ªÉm tra k·∫øt qu·∫£ ph·∫£n h·ªìi
            if response.status_code == 200 and response.json().get("message") == "Thao t√°c th√†nh c√¥ng":
                self.table.setItem(row, 6, QTableWidgetItem("‚úÖ ƒê√£ Set M√£ PIN"))
            else:
                error_message = response.json().get("message", "Kh√¥ng x√°c ƒë·ªãnh")
                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói Set PIN {error_message}"))
                print(response.json())

        except Exception as e:
            self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói: {str(e)}"))

    def CheckCacLienKet(self):
        import requests
        from concurrent.futures import ThreadPoolExecutor, as_completed
        from qtpy.QtWidgets import QTableWidgetItem
        def chay_20_mot_luot():
            def xu_ly_row(row):
                try:
                    token = self.table.item(row, 0).text()
                    proxy = self.table.item(row, 1).text()
                    Fidd = self.table.item(row, 4).text()
                    self.table.setItem(row, 6, QTableWidgetItem(f"[XXX] Ki·ªÉm Tra Proxy!"))
                    headers = {
                        "authority": "m.oklavip26.live",
                        "accept": "application/json, text/plain, */*",
                        "accept-language": "vi-VN,vi;q=0.9",
                        "content-type": "application/json",
                        "locale": "vi_vn",
                        "origin": "https://m.oklavip26.live",
                        "priority": "u=1, i",
                        "referer": "https://m.oklavip26.live/login",
                        "sec-ch-ua": '"Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"',
                        "sec-ch-ua-mobile": "?0",
                        "sec-ch-ua-platform": "Windows",
                        "sec-fetch-dest": "empty",
                        "sec-fetch-mode": "cors",
                        "sec-fetch-site": "same-origin",
                        "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                        "f-id": Fidd,
                        "token": token
                    }
                    proxy_url, port, username, password = proxy.split(':')
                    proxy_address = f"http://{username}:{password}@{proxy_url}:{port}"
                    proxies = {
                        "http": proxy_address,
                        "https": proxy_address
                    }
                    response = requests.get("https://m.oklavip26.live/api/website/listForWallet", headers=headers, proxies=proxies, timeout=500).json()
                    bindings = []

                    for site in response["data"]:
                        if not site["isBind"]:
                            bindings.append(site["websiteName"])  # ho·∫∑c site["memberName"] n·∫øu c·∫ßn

                    result_text = " ".join(bindings)

                    self.table.setItem(row, 7, QTableWidgetItem(result_text))
                    self.table.setItem(row, 6, QTableWidgetItem(f"[OK] Ho√†n Th√†nh L·∫•y Li√™n K·∫øt"))
                    # L∆∞u l·∫°i d√≤ng v√†o file ACC.txt
                    if self.save_row_to_file(row):
                        pass  # Successfully saved
                except Exception as e:
                    self.table.setItem(row, 6, QTableWidgetItem(f"[ERR] {str(e)}"))
            with ThreadPoolExecutor(max_workers=50) as executor:
                futures = [executor.submit(xu_ly_row, row) for row in range(self.table.rowCount())]
                for future in as_completed(futures):
                    pass
        chay_20_mot_luot()

    def delete_all_banned_accounts(self):
        # X√≥a t·∫•t c·∫£ c√°c d√≤ng c√≥ tr·∫°ng th√°i 'L·ªói: T√†i kho·∫£n ƒë√£ b·ªã c·∫•m d√πng'
        banned_text = "L·ªói: T√†i kho·∫£n ƒë√£ b·ªã c·∫•m d√πng"
        rows_to_delete = []
        for row in range(self.table.rowCount()):
            item = self.table.item(row, 6)
            if item and banned_text in item.text():
                rows_to_delete.append(row)
        if not rows_to_delete:
            return
        # X√≥a t·ª´ cu·ªëi l√™n ƒë·ªÉ kh√¥ng b·ªã l·ªách ch·ªâ s·ªë
        for row in reversed(rows_to_delete):
            self.table.removeRow(row)
        # X√≥a trong file ACC.txt
        try:
            acc_file = FILE_PATH
            with self.file_lock:
                # ƒê·ªçc t·ª´ file g·ªëc tr∆∞·ªõc
                if os.path.exists(acc_file):
                    with open(acc_file, "r", encoding="utf-8") as f:
                        lines = f.readlines()
                else:
                    lines = []
                
                # X√≥a c√°c d√≤ng t∆∞∆°ng ·ª©ng
                for row in reversed(rows_to_delete):
                    if 0 <= row < len(lines):
                        lines.pop(row)
                
                tmp_file = acc_file + ".tmp"
                with open(tmp_file, "w", encoding="utf-8") as f:
                    f.writelines(lines)
                    f.flush()
                    os.fsync(f.fileno())
                os.replace(tmp_file, acc_file)
            print(f"[LOG] ƒê√£ x√≥a t·∫•t c·∫£ ACC b·ªã c·∫•m kh·ªèi file ACC.txt")
        except Exception as e:
            print(f"[LOG] L·ªói x√≥a ACC b·ªã c·∫•m kh·ªèi file ACC.txt: {e}")

    def sort_by_point_and_save(self):
        # S·∫Øp x·∫øp b·∫£ng theo c·ªôt ƒëi·ªÉm (c·ªôt 5, gi·∫£m d·∫ßn) v√† l∆∞u l·∫°i v√†o file ACC.txt
        data = []
        for row in range(self.table.rowCount()):
            row_data = []
            for col in range(self.table.columnCount()):
                item = self.table.item(row, col)
                row_data.append(item.text() if item else "")
            try:
                point = int(row_data[5])
            except:
                point = 0
            data.append((point, row_data))
        # S·∫Øp x·∫øp gi·∫£m d·∫ßn theo ƒëi·ªÉm
        data.sort(key=lambda x: x[0], reverse=True)
        # C·∫≠p nh·∫≠t l·∫°i b·∫£ng
        self.table.setRowCount(0)
        for idx, (point, row_data) in enumerate(data):
            self.table.insertRow(idx)
            for col, value in enumerate(row_data):
                item = QTableWidgetItem(value)
                item.setTextAlignment(Qt.AlignCenter)
                self.table.setItem(idx, col, item)
            self.password_map[idx] = row_data[3]
        # L∆∞u l·∫°i v√†o file ACC.txt
        try:
            acc_file = FILE_PATH
            with self.file_lock:
                tmp_file = acc_file + ".tmp"
                with open(tmp_file, "w", encoding="utf-8") as f:
                    for _, row_data in data:
                        # ƒê·∫£m b·∫£o c√≥ 8 tr∆∞·ªùng
                        if len(row_data) < 8:
                            row_data += [""] * (8 - len(row_data))
                        f.write("|".join(row_data) + "\n")
                    f.flush()
                    os.fsync(f.fileno())
                os.replace(tmp_file, acc_file)
            print("[LOG] ƒê√£ l∆∞u l·∫°i ACC.txt sau khi s·∫Øp x·∫øp theo ƒëi·ªÉm.")
        except Exception as e:
            print(f"[LOG] L·ªói l∆∞u ACC.txt sau khi s·∫Øp x·∫øp: {e}")

    def rut_full_diem_all(self):
        """R√∫t full ƒëi·ªÉm cho t·∫•t c·∫£ t√†i kho·∫£n v·ªõi logic chia nh·ªè"""
        from qtpy.QtWidgets import QDialog, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, QComboBox, QLineEdit
        from qtpy.QtCore import QTimer
        import threading
        
        # Danh s√°ch game m·∫´u
        game_list = [
            {"memberCode": "MOCBAI", "websiteName": "MB66", "id": "1739230912039436290"},
            {"memberCode": "OK9", "websiteName": "OK9", "id": "1798608608416931842"},
            {"memberCode": "78win", "websiteName": "78win", "id": "1814571722874535937"},
            {"memberCode": "QQ88", "websiteName": "QQ88", "id": "1863085503318499329"},
            {"memberCode": "F168", "websiteName": "F168", "id": "1863085976314355713"},
        ]
        
        # T·∫°o dialog ƒë·ªÉ ch·ªçn game v√† nh·∫≠p PIN
        dialog = QDialog(self)
        dialog.setWindowTitle("R√∫t Full ƒêi·ªÉm")
        dialog.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #23243a, stop:1 #181928);
                color: #fff;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 16px;
                border-radius: 18px;
            }
            QLabel {
                color: #ffa726;
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 6px;
            }
            QLineEdit, QComboBox {
                padding: 12px 14px;
                border: 1.5px solid #444;
                border-radius: 10px;
                background-color: #23243a;
                color: #fff;
                font-size: 16px;
                margin-bottom: 12px;
            }
            QPushButton {
                background-color: #ffa726;
                padding: 14px 0;
                border: none;
                border-radius: 10px;
                font-weight: bold;
                color: #23243a;
                font-size: 18px;
                margin-top: 18px;
                margin-bottom: 8px;
            }
            QPushButton:hover {
                background-color: #ffb74d;
                color: #181928;
            }
        """)
        
        layout = QVBoxLayout(dialog)
        
        # Ch·ªçn game
        game_label = QLabel("Ch·ªçn Game:")
        layout.addWidget(game_label)
        game_combo = QComboBox()
        for game in game_list:
            game_combo.addItem(game['websiteName'], game)
        layout.addWidget(game_combo)
        
        # Nh·∫≠p PIN
        pin_label = QLabel("Nh·∫≠p M√£ PIN:")
        layout.addWidget(pin_label)
        pin_input = QLineEdit()
        pin_input.setPlaceholderText("Nh·∫≠p m√£ PIN")
        layout.addWidget(pin_input)
        
        # N√∫t b·∫Øt ƒë·∫ßu
        start_btn = QPushButton("B·∫Øt ƒê·∫ßu R√∫t Full ƒêi·ªÉm")
        layout.addWidget(start_btn)
        
        def start_rut_full():
            selected_game = game_combo.currentData()
            pin = pin_input.text().strip()
            
            if not pin:
                from qtpy.QtWidgets import QMessageBox
                QMessageBox.warning(dialog, "L·ªói", "Vui l√≤ng nh·∫≠p m√£ PIN!")
                return
            
            dialog.accept()
            
            # B·∫Øt ƒë·∫ßu r√∫t full ƒëi·ªÉm
            threading.Thread(target=self._rut_full_diem_thread, args=(selected_game, pin), daemon=True).start()
        
        start_btn.clicked.connect(start_rut_full)
        
        if dialog.exec() == QDialog.Accepted:
            pass

    def _rut_full_diem_thread(self, game_info, pin):
        """Thread x·ª≠ l√Ω r√∫t full ƒëi·ªÉm cho t·∫•t c·∫£ t√†i kho·∫£n"""
        import requests
        import hashlib
        import time
        from qtpy.QtWidgets import QTableWidgetItem
        
        def create_proxy(proxy_string):
            parts = proxy_string.split(":")
            ip = parts[0]
            port = parts[1]
            username = parts[2]
            password = parts[3]
            proxies = {
                "http": f"http://{username}:{password}@{ip}:{port}",
                "https": f"http://{username}:{password}@{ip}:{port}"
            }
            return proxies
        
        def calculate_withdraw_amounts(total_points):
            """Chia nh·ªè s·ªë ƒëi·ªÉm: >=50 th√¨ r√∫t 50, <50 th√¨ r√∫t h·∫øt s·ªë c√≤n l·∫°i (n·∫øu >=10), <10 th√¨ kh√¥ng r√∫t"""
            if total_points < 10:
                return []
            amounts = []
            remaining = total_points
            while remaining >= 10:
                if remaining >= 50:
                    amounts.append(50)
                    remaining -= 50
                else:
                    amounts.append(remaining)
                    remaining = 0
            return amounts
        
        def rut_diem_single(row, amount):
            """R√∫t m·ªôt l·∫ßn v·ªõi s·ªë ƒëi·ªÉm c·ª• th·ªÉ"""
            try:
                token = self.table.item(row, 0).text()
                proxy = self.table.item(row, 1).text()
                f_id = self.table.item(row, 4).text()
                
                if not token or token.strip() == "":
                    return False, "Token tr·ªëng"
                
                headers = {
                    "accept": "application/json, text/plain, */*",
                    "content-type": "application/json",
                    "f-id": f_id,
                    "locale": "vi_vn",
                    "referer": "https://m.oklavip26.live/wallet?type=0",
                    "token": token,
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
                }
                
                pin_md5 = hashlib.md5(pin.encode('utf-8')).hexdigest()
                data = {
                    "withdrawPoint": str(amount),
                    "withdrawPassword": pin_md5,
                    "websiteId": game_info["id"],
                    "memberCode": game_info["memberCode"]
                }
                
                proxies = create_proxy(proxy)
                response = requests.post(
                    "https://m.oklavip26.live/api/withdrawRecord/withdraw",
                    headers=headers,
                    json=data,
                    proxies=proxies,
                    timeout=15
                )
                
                if response.status_code == 200:
                    resp_data = response.json()
                    if resp_data.get("code") == 200:
                        return True, f"R√∫t {amount} ƒëi·ªÉm th√†nh c√¥ng"
                    else:
                        return False, f"L·ªói: {resp_data.get('message', 'Kh√¥ng r√µ')}"
                else:
                    return False, f"HTTP {response.status_code}"
                    
            except Exception as e:
                return False, f"Exception: {str(e)}"
        
        # X·ª≠ l√Ω t·ª´ng t√†i kho·∫£n
        for row in range(self.table.rowCount()):
            try:
                # L·∫•y ƒëi·ªÉm hi·ªán t·∫°i
                point_item = self.table.item(row, 5)
                if not point_item:
                    continue
                
                try:
                    current_points = int(point_item.text())
                except:
                    current_points = 0
                
                if current_points < 10:
                    self.table.setItem(row, 6, QTableWidgetItem("ƒêi·ªÉm kh√¥ng ƒë·ªß ƒë·ªÉ r√∫t (t·ªëi thi·ªÉu 10)"))
                    continue
                
                self.table.setItem(row, 6, QTableWidgetItem(f"B·∫Øt ƒë·∫ßu r√∫t full {current_points} ƒëi·ªÉm..."))
                
                # T√≠nh to√°n c√°c l·∫ßn r√∫t
                withdraw_amounts = calculate_withdraw_amounts(current_points)
                
                if not withdraw_amounts:
                    self.table.setItem(row, 6, QTableWidgetItem("Kh√¥ng th·ªÉ t√≠nh to√°n s·ªë l∆∞·ª£ng r√∫t"))
                    continue
                
                success_count = 0
                total_withdrawn = 0
                
                for i, amount in enumerate(withdraw_amounts):
                    self.table.setItem(row, 6, QTableWidgetItem(f"R√∫t l·∫ßn {i+1}/{len(withdraw_amounts)}: {amount} ƒëi·ªÉm..."))
                    
                    success, message = rut_diem_single(row, amount)
                    
                    if success:
                        success_count += 1
                        total_withdrawn += amount
                        self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ {message} ({i+1}/{len(withdraw_amounts)})"))
                    else:
                        self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·∫ßn {i+1}: {message}"))
                        break  # D·ª´ng n·∫øu c√≥ l·ªói
                    
                    # Delay gi·ªØa c√°c l·∫ßn r√∫t
                    time.sleep(2)
                
                # C·∫≠p nh·∫≠t ƒëi·ªÉm c√≤n l·∫°i
                remaining_points = current_points - total_withdrawn
                self.table.setItem(row, 5, QTableWidgetItem(str(remaining_points)))
                
                if success_count == len(withdraw_amounts):
                    self.table.setItem(row, 6, QTableWidgetItem(f"‚úÖ R√∫t full th√†nh c√¥ng: {total_withdrawn}/{current_points} ƒëi·ªÉm"))
                else:
                    self.table.setItem(row, 6, QTableWidgetItem(f"‚ö†Ô∏è R√∫t m·ªôt ph·∫ßn: {total_withdrawn}/{current_points} ƒëi·ªÉm"))
                
                # L∆∞u l·∫°i v√†o file ACC.txt
                if self.save_row_to_file(row):
                    print(f"[LOG] ƒê√£ l∆∞u d√≤ng sau khi r√∫t ƒëi·ªÉm cho d√≤ng {row}")
                
                # Delay gi·ªØa c√°c t√†i kho·∫£n
                time.sleep(3)
                
            except Exception as e:
                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói x·ª≠ l√Ω: {str(e)}"))
                continue

    def ngay_moi_all(self):
        """Ch·∫°y l·∫ßn l∆∞·ª£t: KI·ªÇM TRA PROXY, ƒêI·ªÇM DANH, L·∫§Y LI√äN K·∫æT, L·∫§Y ƒêI·ªÇM cho t·∫•t c·∫£ acc"""
        import threading
        import time
        def run_all():
            self.check_proxy_all()
            time.sleep(10)
            self.diem_danh_all()
            time.sleep(2)
            self.CheckCacLienKet()
            time.sleep(2)
            self.get_point_all()
        threading.Thread(target=run_all, daemon=True).start()

    def change_password_all(self):
        from qtpy.QtWidgets import QDialog, QVBoxLayout, QLabel, QLineEdit, QPushButton, QMessageBox
        import threading

        class ChangePassDialog(QDialog):
            def __init__(self, parent=None):
                super().__init__(parent)
                self.setWindowTitle("Thay m·∫≠t kh·∫©u t·∫•t c·∫£")
                layout = QVBoxLayout(self)
                layout.addWidget(QLabel("Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (s·∫Ω √°p d·ª•ng cho t·∫•t c·∫£):"))
                self.new_pass_input = QLineEdit()
                self.new_pass_input.setEchoMode(QLineEdit.Password)
                layout.addWidget(self.new_pass_input)
                self.btn = QPushButton("B·∫Øt ƒë·∫ßu thay m·∫≠t kh·∫©u")
                layout.addWidget(self.btn)
                self.btn.clicked.connect(self.accept)

        dialog = ChangePassDialog(self)
        if dialog.exec() == QDialog.Accepted:
            new_password = dialog.new_pass_input.text().strip()
            if not new_password:
                QMessageBox.warning(self, "L·ªói", "B·∫°n ph·∫£i nh·∫≠p m·∫≠t kh·∫©u m·ªõi!")
                return

            def worker():
                import hashlib, requests, time
                for row in range(self.table.rowCount()):
                    try:
                        token = self.table.item(row, 0).text()
                        old_pass = self.table.item(row, 3).text()
                        f_id = self.table.item(row, 4).text()
                        proxy = self.table.item(row, 1).text()
                        if not token or not old_pass:
                            self.table.setItem(row, 6, QTableWidgetItem("Thi·∫øu token ho·∫∑c m·∫≠t kh·∫©u c≈©"))
                            continue
                        old_pass_md5 = old_pass
                        if len(old_pass) != 32:
                            old_pass_md5 = hashlib.md5(old_pass.encode('utf-8')).hexdigest()
                        new_pass_md5 = hashlib.md5(new_password.encode('utf-8')).hexdigest()
                        headers = {
                            "accept": "application/json, text/plain, */*",
                            "content-type": "application/json",
                            "locale": "vi_vn",
                            "referer": "https://m.okvipau.com/setpassword",
                            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
                            "f-id": f_id,
                            "token": token
                        }
                        try:
                            ip, port, user, pwd = proxy.split(":")
                            proxy_url = f"http://{user}:{pwd}@{ip}:{port}"
                            proxies = {"http": proxy_url, "https": proxy_url}
                        except Exception:
                            proxies = None
                        payload = {
                            "oldPassword": old_pass_md5,
                            "newPassword": new_pass_md5,
                            "confirmPassword": new_pass_md5
                        }
                        self.table.setItem(row, 6, QTableWidgetItem("ƒêang thay m·∫≠t kh·∫©u..."))
                        resp = requests.post(
                            "https://m.okvipau.com/api/account/updatePassword",
                            headers=headers,
                            json=payload,
                            proxies=proxies,
                            timeout=20
                        )
                        try:
                            resp_json = resp.json()
                            if resp.status_code == 200 and resp_json.get("code", 200) == 200:
                                self.table.setItem(row, 6, QTableWidgetItem("‚úÖ ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u"))
                                self.table.setItem(row, 3, QTableWidgetItem(new_password))
                                self.save_row_to_file(row)
                            else:
                                msg = resp_json.get("message", "L·ªói kh√¥ng r√µ")
                                self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói: {msg}"))
                        except Exception as e:
                            self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói: {str(e)}"))
                        time.sleep(1)
                    except Exception as e:
                        self.table.setItem(row, 6, QTableWidgetItem(f"‚ùå L·ªói: {str(e)}"))
            threading.Thread(target=worker, daemon=True).start()

class GetPointWorker(QRunnable):
    def __init__(self, row, token, f_id, proxy_string):
        super().__init__()
        self.row = row
        self.token = token
        self.f_id = f_id
        self.proxy_string = proxy_string
        self.signals = LoginSignals()

    def create_proxy(self, proxy_string):
        parts = proxy_string.split(":")
        ip = parts[0]
        port = parts[1]
        username = parts[2]
        password = parts[3]
        proxies = {
            "http": f"http://{username}:{password}@{ip}:{port}",
            "https": f"http://{username}:{password}@{ip}:{port}"
        }
        return proxies

    def run(self):
        import requests
        proxies = self.create_proxy(self.proxy_string)
        try:
            headers = {
                "authority": "m.oklavip26.live",
                "accept": "application/json, text/plain, */*",
                "accept-language": "vi-VN,vi;q=0.9",
                "content-type": "application/json",
                "locale": "vi_vn",
                "referer": "https://m.oklavip26.live/personal",
                "sec-ch-ua-platform": "Windows",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-origin",
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/114.0.144 Chrome/114.0.0.0 Safari/537.36",
                "f-id": self.f_id,
                "token": self.token,
            }
            responsediem = requests.get("https://m.oklavip26.live/api/wallet/getWallet", headers=headers, proxies=proxies, timeout=20).json()
            print(responsediem)
            diem = responsediem['data']['integral']
            self.signals.update_status.emit(self.row, f"L·∫•y ƒëi·ªÉm th√†nh c√¥ng: {diem}")
            self.signals.login_result.emit(self.row, self.token, "GET_POINT_OK", diem, None)
        except Exception as e:
            print(f"GetPointWorker Exception: {e}")
            self.signals.update_status.emit(self.row, "L·∫•y ƒëi·ªÉm th·∫•t b·∫°i!")
            self.signals.login_result.emit(self.row, self.token, "GET_POINT_FAIL", None, str(e))

class ThuanLienKet(QThread):
    result = Signal(int, str)  # row, message
    def __init__(self, selected_rows, accounts, game_info, game_account, game_phone, parent=None):
        super().__init__(parent)
        self.selected_rows = selected_rows
        self.accounts = accounts
        self.game_info = game_info
        self.game_account = game_account
        self.game_phone = game_phone
    def run(self):
        import requests
        def create_proxy(proxy_string):
            parts = proxy_string.split(":")
            ip = parts[0]
            port = parts[1]
            username = parts[2]
            password = parts[3]
            proxies = {
                "http": f"http://{username}:{password}@{ip}:{port}",
                "https": f"http://{username}:{password}@{ip}:{port}"
            }
            return proxies
        row = self.selected_rows[0]
        account = self.accounts[0]
        token = account[0]
        proxy = account[1]
        tkkk = account[2]
        password = account[3]
        f_id = account[4]
        self.result.emit(row, f"ƒêang li√™n k·∫øt t√†i kho·∫£n game...")
        headers = {
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "f-id": f_id,
            "locale": "vi_vn",
            "referer": "https://m.oklavip26.live/wallet?type=0",
            "token": token,
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
        }
        data = {
            "gameAccount": self.game_account,
            "gamePhone": self.game_phone,
            "websiteId": self.game_info["id"],
            "memberCode": self.game_info["memberCode"]
        }
        try:
            proxies = create_proxy(proxy)
            response = requests.post(
                "https://m.oklavip26.live/api/wallet/bindGameAccount",
                headers=headers,
                json=data,
                proxies=proxies,
                timeout=10
            )
            self.result.emit(row, f"‚úÖ {response.status_code} - {response.text}")
        except Exception as e:
            self.result.emit(row, f"‚ùå L·ªói: {str(e)}")

class GameInputDialog(QDialog):
    def __init__(self, game_list, Thuan, s1, s2, parent=None):
        super().__init__(parent)
        self.setWindowTitle(Thuan)
        self.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #23243a, stop:1 #181928);
                color: #fff;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 16px;
                border-radius: 18px;
            }
            QLabel {
                color: #ffa726;
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 6px;
            }
            QLineEdit {
                padding: 12px 14px;
                border: 1.5px solid #444;
                border-radius: 10px;
                background-color: #23243a;
                color: #fff;
                font-size: 16px;
                margin-bottom: 12px;
            }
            QPushButton {
                background-color: #ffa726;
                padding: 14px 0;
                border: none;
                border-radius: 10px;
                font-weight: bold;
                color: #23243a;
                font-size: 18px;
                margin-top: 18px;
                margin-bottom: 8px;
            }
            QPushButton:hover {
                background-color: #ffb74d;
                color: #181928;
            }
            QTabWidget::pane {
                border: none;
                background: transparent;
            }
            QTabBar::tab {
                background: #23243a;
                color: #fff;
                padding: 10px 32px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
                font-size: 16px;
                margin-right: 2px;
            }
            QTabBar::tab:selected {
                background: #ffa726;
                color: #23243a;
            }
        """)
        self.selected_game = None
        self.game_account = ""
        self.game_phone = ""
        main_layout = QVBoxLayout()
        self.tab_widget = QTabWidget()
        self.tab_data = {}  # tab index -> game data
        for game in game_list:
            tab = QWidget()
            layout = QFormLayout()
            layout.setLabelAlignment(Qt.AlignLeft)
            layout.setFormAlignment(Qt.AlignTop)
            account_input = QLineEdit()
            phone_input = QLineEdit()
            layout.addRow(s1 + ':', account_input)
            layout.addRow(s2 + ':', phone_input)
            tab.setLayout(layout)
            self.tab_widget.addTab(tab, game['websiteName'])
            self.tab_data[self.tab_widget.count() - 1] = {
                "game": game,
                "account_input": account_input,
                "phone_input": phone_input
            }
        main_layout.addWidget(self.tab_widget)
        self.btn = QPushButton("Li√™n k·∫øt")
        self.btn.clicked.connect(self.accept)
        main_layout.addWidget(self.btn)
        self.setLayout(main_layout)
        self.resize(480, 340)
    def accept(self):
        index = self.tab_widget.currentIndex()
        data = self.tab_data.get(index)
        if data:
            self.selected_game = data["game"]
            self.game_account = data["account_input"].text()
            self.game_phone = data["phone_input"].text()
        super().accept()

class Thuanrutdiem(QThread):
    result = Signal(int, str)
    def __init__(self, selected_rows, accounts, game_info, game_account, game_phone, parent=None):
        super().__init__(parent)
        self.selected_rows = selected_rows
        self.accounts = accounts
        self.game_info = game_info
        self.game_account = game_account
        self.game_phone = game_phone
    def run(self):
        import requests, hashlib
        def create_proxy(proxy_string):
            parts = proxy_string.split(":")
            ip = parts[0]
            port = parts[1]
            username = parts[2]
            password = parts[3]
            proxies = {
                "http": f"http://{username}:{password}@{ip}:{port}",
                "https": f"http://{username}:{password}@{ip}:{port}"
            }
            return proxies
        row = self.selected_rows[0]
        account = self.accounts[0]
        token = account[0]
        proxy = account[1]
        tkkk = account[2]
        password = account[3]
        f_id = account[4]
        self.result.emit(row, f"Th·ª±c Hi·ªán R√∫t ƒêi·ªÉm")
        headers = {
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "f-id": f_id,
            "locale": "vi_vn",
            "referer": "https://m.oklavip26.live/wallet?type=0",
            "token": token,
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36"
        }
        pin_md5 = hashlib.md5(self.game_phone.encode('utf-8')).hexdigest()
        data = {
            "withdrawPoint":  self.game_account,
            "withdrawPassword": pin_md5,
            "websiteId": self.game_info["id"],
            "memberCode": self.game_info["memberCode"]
        }
        try:
            proxies = create_proxy(proxy)
            response = requests.post(
                "https://m.oklavip26.live/api/withdrawRecord/withdraw",
                headers=headers,
                json=data,
                proxies=proxies,
                timeout=10
            )
            self.result.emit(row, f"‚úÖ {response.status_code} - {response.text}")
        except Exception as e:
            self.result.emit(row, f"‚úÖ ƒê√£ Th·ª±c Hi·ªán L·ªánh")

# === DEVICE ID PROTECTION START ===
def get_device_id():
    import os
    device_file = os.path.expanduser("~/.device_id_thuan")
    try:
        if os.path.exists(device_file):
            with open(device_file, "r") as f:
                device_id = f.read().strip()
                if device_id:
                    return device_id
        # T·∫°o m·ªõi d·ª±a tr√™n MAC + user + ·ªï c·ª©ng
        raw = str(uuid.getnode()) + os.environ.get("USERNAME", "") + os.environ.get("COMPUTERNAME", "")
        device_id = hashlib.sha256(raw.encode()).hexdigest()[:16]
        with open(device_file, "w") as f:
            f.write(device_id)
        return device_id
    except Exception as e:
        # N·∫øu l·ªói, fallback d√πng uuid4
        return str(uuid.uuid4())[:16]

def is_device_allowed(device_id):
    import requests
    try:
        url = "https://raw.githubusercontent.com/Thuanvuse/thuanvuse.github.io/refs/heads/main/mycheck.json"
        resp = requests.get(url, timeout=10)
        allowed = [item["thiet_bi"] for item in resp.json()]
        return device_id in allowed
    except Exception as e:
        print("L·ªói ki·ªÉm tra m√£ m√°y:", e)
        return False
# === DEVICE ID PROTECTION END ===

if __name__ == "__main__":
    app = QApplication(sys.argv)
    from qtpy.QtWidgets import QDialog, QVBoxLayout, QLabel, QPushButton
    def show_notice():
        dialog = QDialog()
        dialog.setWindowTitle("Th√¥ng b√°o")
        layout = QVBoxLayout(dialog)
        label = QLabel("Tool ƒëang trong qu√° tr√¨nh ho√†n thi·ªán s·∫Ω ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng")
        label.setWordWrap(True)
        layout.addWidget(label)
        btn = QPushButton("ƒê√≥ng")
        btn.clicked.connect(dialog.accept)
        layout.addWidget(btn)
        # CSS ƒë·∫πp cho dialog
        dialog.setStyleSheet('''
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #4f8cff, stop:1 #8f5cff);
                border-radius: 18px;
            }
            QLabel {
                color: white;
                font-size: 18px;
                font-weight: bold;
                padding: 16px 8px 8px 8px;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #6faaff, stop:1 #3a6cff);
                color: white;
                border-radius: 12px;
                padding: 8px 24px;
                font-size: 15px;
                font-weight: bold;
                border: none;
                margin-bottom: 12px;
            }
            QPushButton:hover {
                background: #2353ff;
            }
        ''')
        dialog.exec_()
    # QTimer.singleShot(0, show_notice)
    win = Table3D()
    win.show()
    sys.exit(app.exec())
